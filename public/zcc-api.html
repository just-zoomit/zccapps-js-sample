<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Zoom Contact Center — Sample Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0b1220;
      --panel: #121a2b;
      --muted: #9fb0d0;
      --text: #eaf1ff;
      --accent: #5aa2ff;
      --good: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --card-radius: 18px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px;
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #0b1220 0%, #0a1020 100%);
      color: var(--text);
    }
    header {
      display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 18px;
    }
    header h1 { font-size: 20px; margin: 0; letter-spacing: .2px; }
    .sub { color: var(--muted); font-size: 13px; }
    .toolbar { display: flex; gap: 10px; align-items: center; }
    button, select {
      background: var(--panel); color: var(--text); border: 1px solid rgba(255,255,255,.08);
      padding: 8px 12px; border-radius: 10px; cursor: pointer;
    }
    button:hover { border-color: rgba(255,255,255,.18); }
    main { display: grid; gap: 14px; grid-template-columns: 1fr; }
    @media (min-width: 760px) {
      main { grid-template-columns: 1.35fr .9fr; }
    }

    /* KPI cards */
    .kpi-grid {
      display: grid; gap: 12px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    @media (min-width: 980px) {
      .kpi-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    .card {
      background: var(--panel); border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--card-radius); padding: 14px 14px 12px;
      display: flex; flex-direction: column; gap: 6px; min-height: 100px;
    }
    .card h3 { margin: 0; font-size: 12px; color: var(--muted); font-weight: 600; letter-spacing: .3px; }
    .value { font-size: 28px; font-weight: 700; letter-spacing: .2px; }
    .subline { color: var(--muted); font-size: 12px; }
    .trend { font-size: 12px; font-weight: 600; }
    .good { color: var(--good); }
    .warn { color: var(--warn); }
    .bad  { color: var(--bad);  }

    /* Right column */
    .panel {
      background: var(--panel); border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--card-radius); padding: 14px;
    }
    .panel h2 { margin: 0 0 10px 0; font-size: 14px; color: var(--muted); letter-spacing: .3px; }

    footer { margin-top: 18px; color: var(--muted); font-size: 12px; }
    .small { font-size: 11px; color: var(--muted); }
    .row { display: flex; gap: 10px; align-items: baseline; justify-content: space-between; }
    .pill {
      display: inline-block; padding: 2px 8px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.1); color: var(--muted); font-size: 12px;
    }
  </style>
</head>
<body>

  <header>
     <div style="background: #f0f4f8; padding: 10px; margin-bottom: 20px; text-align: center;">
    <a href="/index.html" style="font-weight: bold; color: #0066cc; text-decoration: none;">
      Home
    </a>
  </div>

    <div>
      <h1>Contact Center — Snapshot</h1>
      <div class="sub" id="last-updated">Loading…</div>
    </div>
    <div class="toolbar">
      <select id="range">
        <option value="today">Today</option>
        <option value="7d">Last 7 days</option>
        <option value="30d">Last 30 days</option>
      </select>
      <button id="refresh">Refresh</button>
    </div>
  </header>

  <main>
    <section>
      <div class="kpi-grid">
        <div class="card">
          <h3>Total Engagements</h3>
          <div class="value" id="total-engagements">—</div>
          <div class="subline"><span id="by-channel">—</span></div>
        </div>
        <div class="card">
          <h3>Answered vs Missed</h3>
          <div class="value"><span id="answered">—</span> / <span id="missed">—</span></div>
          <div class="subline"><span id="miss-rate">—</span> miss rate</div>
        </div>
        <div class="card">
          <h3>Service Level (≤30s)</h3>
          <div class="value" id="service-level">—</div>
          <div class="subline"><span id="sl-denom">—</span> calls in window</div>
        </div>
        <div class="card">
          <h3>Avg Wait (ASA)</h3>
          <div class="value" id="avg-wait">—</div>
          <div class="subline">Average time before answer</div>
        </div>
        <div class="card">
          <h3>Avg Handle Time (AHT)</h3>
          <div class="value" id="avg-handle">—</div>
          <div class="subline">Talk + hold + wrap</div>
        </div>
        <div class="card">
          <h3>CSAT</h3>
          <div class="value" id="csat">—</div>
          <div class="subline" id="csat-count">— responses</div>
        </div>
      </div>
    </section>

    <aside class="panel">
      <h2>Answered vs Missed (share of total)</h2>
      <canvas id="pie" width="320" height="320" aria-label="Answered vs Missed Pie"></canvas>
      <div class="row" style="margin-top:10px;">
        <span class="pill">Agents Online: <span id="agents-online">—</span></span>
        <span class="pill">Queues: <span id="queues-count">—</span></span>
      </div>
    </aside>
  </main>

  <footer>
    <div class="small">
      Data source: Zoom Contact Center (REST) — snapshot on load. Update via <em>Refresh</em>.
    </div>
  </footer>

  <!-- Chart.js for a tiny pie; you can remove this and render text-only if you prefer -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  
  <script>
    /**
     * Expected backend response (example):
     * GET /api/cc/metrics?range=today
     * {
     *   "range": "today",
     *   "generatedAt": "2025-09-08T10:05:12Z",
     *   "volume": { "total": 160, "answered": 146, "missed": 14, "byChannel": { "voice": 120, "chat": 30, "sms": 10 } },
     *   "performance": { "avgWaitSeconds": 24, "avgHandleSeconds": 270, "serviceLevelPct": 86, "serviceLevelDenominator": 160 },
     *   "quality": { "csatAvg": 4.6, "csatCount": 73 },
     *   "summary": { "agentsOnline": 18, "queuesCount": 5 }
     * }
     *
     * NOTE: Your backend should:
     * - Call Zoom Contact Center REST APIs with your app's auth.
     * - Aggregate/compute metrics above (ASA, AHT, SL ≤30s, etc.).
     * - Return JSON to the Zoom App homepage (this file).
     */

    const USE_MOCK_WHEN_ERROR = true; // set false in production

    const el = (id) => document.getElementById(id);
    const fmtTime = (secs) => {
      if (secs == null || isNaN(secs)) return "—";
      const m = Math.floor(secs / 60), s = Math.round(secs % 60);
      return m > 0 ? `${m}m ${s}s` : `${s}s`;
    };

    let pieChart;

    async function loadMetrics() {
      const range = el('range').value;
      const url = `/api/cc/metrics?range=${encodeURIComponent(range)}`;
      try {
        const res = await fetch(url, { credentials: 'include' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        render(data);
      } catch (err) {
        console.warn('Falling back to mock metrics:', err);
        if (USE_MOCK_WHEN_ERROR) render(mockMetrics(range));
        else showError(err);
      }
    }

    function render(data) {
      const { volume, performance, quality, summary, generatedAt } = data;

      // Header
      el('last-updated').textContent = `Updated ${new Date(generatedAt || Date.now()).toLocaleString()}`;

      // KPIs
      el('total-engagements').textContent = num(volume?.total);
      el('by-channel').textContent = volume?.byChannel
        ? Object.entries(volume.byChannel).map(([k,v]) => `${capitalize(k)}: ${num(v)}`).join(' · ')
        : '—';

      el('answered').textContent = num(volume?.answered);
      el('missed').textContent = num(volume?.missed);
      const missRate = rate(volume?.missed, volume?.total);
      el('miss-rate').textContent = missRate != null ? `${missRate}%` : '—';

      el('service-level').textContent = pct(performance?.serviceLevelPct);
      el('sl-denom').textContent = num(performance?.serviceLevelDenominator) + ' total';

      el('avg-wait').textContent = fmtTime(performance?.avgWaitSeconds);
      el('avg-handle').textContent = fmtTime(performance?.avgHandleSeconds);

      el('csat').textContent = quality?.csatAvg != null ? `${quality.csatAvg.toFixed(1)} / 5` : '—';
      el('csat-count').textContent = quality?.csatCount != null ? `${num(quality.csatCount)} responses` : '—';

      el('agents-online').textContent = summary?.agentsOnline != null ? num(summary.agentsOnline) : '—';
      el('queues-count').textContent = summary?.queuesCount != null ? num(summary.queuesCount) : '—';

      // Pie
      const answered = volume?.answered ?? 0;
      const missed = volume?.missed ?? 0;
      drawPie([answered, missed]);
    }

    function drawPie(values) {
      const ctx = document.getElementById('pie').getContext('2d');
      if (pieChart) pieChart.destroy();
      pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Answered', 'Missed'],
          datasets: [{ data: values }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom', labels: { color: '#eaf1ff' } },
            tooltip: { callbacks: {
              label: (i) => `${i.label}: ${num(i.raw)}`
            }}
          }
        }
      });
    }

    function num(n) { return (n == null || isNaN(n)) ? '—' : Number(n).toLocaleString(); }
    function pct(p) { return (p == null || isNaN(p)) ? '—' : `${Math.round(p)}%`; }
    function rate(part, whole) {
      if (part == null || whole == null || whole === 0) return null;
      return Math.round((Number(part) / Number(whole)) * 100);
    }
    function capitalize(s){ return (s||'').slice(0,1).toUpperCase() + (s||'').slice(1); }
    function showError(err){
      el('last-updated').textContent = 'Failed to load data';
      console.error(err);
    }

    function mockMetrics(range) {
      const seed = range === '30d' ? 30 : range === '7d' ? 7 : 1;
      const total = 120 * seed;
      const missed = Math.max(4 * seed, Math.round(total * 0.08));
      const answered = total - missed;
      const sl = 86;
      const avgWait = 22;
      const avgHandle = 265;
      return {
        range,
        generatedAt: new Date().toISOString(),
        volume: {
          total, answered, missed,
          byChannel: { voice: Math.round(total * 0.75), chat: Math.round(total * 0.19), sms: Math.round(total * 0.06) }
        },
        performance: {
          avgWaitSeconds: avgWait,
          avgHandleSeconds: avgHandle,
          serviceLevelPct: sl,
          serviceLevelDenominator: total
        },
        quality: { csatAvg: 4.6, csatCount: 72 * seed },
        summary: { agentsOnline: 18, queuesCount: 5 }
      };
    }

    // Events
    document.getElementById('refresh').addEventListener('click', loadMetrics);
    document.getElementById('range').addEventListener('change', loadMetrics);

    // Start
    loadMetrics();
  </script>
</body>
</html>
