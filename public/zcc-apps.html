<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ZCC App Minimal (with localStorage)</title>
    <script src="https://appssdk.zoom.us/sdk.js"></script>
    <style>
      body { font-family: system-ui, sans-serif; margin: 18px; }
      .row { margin: 8px 0; }
      textarea { width: 100%; min-height: 140px; }
      .hint { opacity: 0.7; font-size: 0.9em; }
    </style>
  </head>

  <body>
    <h1>Zoom Contact Center</h1>

    <div class="row"><strong>Running Context:</strong> <span id="running-context">—</span></div>
    <div class="row"><strong>Engagement ID:</strong> <span id="engagement-id">—</span></div>
    <div class="row"><strong>Status:</strong> <span id="engagement-status">—</span></div>

    <div class="row">
      <label for="notes-textarea"><strong>Notes (saved per engagement)</strong></label><br />
      <textarea id="notes-textarea" placeholder="Type notes…"></textarea>
      <div class="hint">Notes auto-save for this engagement and clear when it ends.</div>
    </div>

    <script>
      (async () => {
        /** ---------- Tiny DOM helpers ---------- */
        const byId = (id) => document.getElementById(id);
        const setTextContent = (id, value) => { byId(id).textContent = value; };

        /** Build the localStorage key for a given engagement id */
        const notesKeyForEngagement = (engagementId) => `zcc-notes:${engagementId}`;

        /** Safe localStorage wrapper (avoids exceptions in restrictive envs) */
        const storage = {
          get(key) { try { return localStorage.getItem(key); } catch { return null; } },
          set(key, value) { try { localStorage.setItem(key, value); } catch {} },
          remove(key) { try { localStorage.removeItem(key); } catch {} },
        };

        if (typeof zoomSdk === "undefined") {
          document.body.insertAdjacentHTML("beforeend", "<p class='hint'>zoomSdk not found.</p>");
          return;
        }

        /** ---------- Configure SDK ---------- */
        await zoomSdk.config({
          version: "0.16.0",
          capabilities: [
            "getRunningContext",
            "getEngagementContext",
            "getEngagementStatus",
            "onEngagementContextChange",
            "onEngagementStatusChange",
          ],
        });

        /** ---------- Initial values ---------- */
        const runningContext = await zoomSdk.getRunningContext();
        setTextContent(
          "running-context",
          typeof runningContext === "string" ? runningContext : JSON.stringify(runningContext)
        );

        let currentEngagementId = "";
        let currentEngagementState = "";

        /** Load context + status and hydrate notes for the active engagement */
        async function loadEngagementInfo() {
          const [contextResponse, statusResponse] = await Promise.all([
            zoomSdk.getEngagementContext().catch(() => null),
            zoomSdk.getEngagementStatus().catch(() => null),
          ]);

          currentEngagementId = contextResponse?.engagementContext?.engagementId || "";
          currentEngagementState = statusResponse?.engagementStatus?.state || "";

          setTextContent("engagement-id", currentEngagementId || "—");
          setTextContent("engagement-status", currentEngagementState || "—");

          // Load saved notes for this engagement (if any)
          byId("notes-textarea").value = currentEngagementId
            ? (storage.get(notesKeyForEngagement(currentEngagementId)) || "")
            : "";
        }

        /** ---------- Notes auto-save (per engagement) ---------- */
        byId("notes-textarea").addEventListener("input", (e) => {
          if (currentEngagementId) {
            storage.set(notesKeyForEngagement(currentEngagementId), e.target.value);
          }
        });

        /** ---------- Live updates from ZCC ---------- */
        function handleEngagementContextChange(evt) {
          currentEngagementId = evt?.engagementContext?.engagementId || "";
          setTextContent("engagement-id", currentEngagementId || "—");
          byId("notes-textarea").value = currentEngagementId
            ? (storage.get(notesKeyForEngagement(currentEngagementId)) || "")
            : "";
        }

        function handleEngagementStatusChange(evt) {
          currentEngagementState = evt?.engagementStatus?.state || "";
          setTextContent("engagement-status", currentEngagementState || "—");

          // Clear saved notes when engagement ends
          if (currentEngagementState === "end" && currentEngagementId) {
            storage.remove(notesKeyForEngagement(currentEngagementId));
            byId("notes-textarea").value = "";
          }
        }

        zoomSdk.addEventListener("onEngagementContextChange", handleEngagementContextChange);
        zoomSdk.addEventListener("onEngagementStatusChange", handleEngagementStatusChange);

        /** Kick off initial load */
        await loadEngagementInfo();
      })();
    </script>
  </body>
</html>
